<template>
  <div class="user-list-page">
    <!-- ÊêúÁ¥¢Ë°®Âçï -->
    <div class="mb-4">
      <a-form layout="inline" @submit.prevent="() => handleSearch()">
        <a-form-item label="ÊâãÊú∫Âè∑">
          <a-input
            v-model:value="formState.phone"
            placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑"
            style="width: 120px !important"
            allowClear
          />
        </a-form-item>

        <a-form-item label="ÊòØÂê¶Â∞ä‰∫´Âç°‰ºöÂëò">
          <a-select
            v-model:value="formState.vip"
            placeholder="ËØ∑ÈÄâÊã©"
            style="width: 80px !important"
            allowClear
            :getPopupContainer="(triggerNode) => triggerNode.parentNode"
          >
            <a-select-option value="1">ÊòØ</a-select-option>
            <a-select-option value="0">Âê¶</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="Áî®Êà∑Áä∂ÊÄÅ">
          <a-select
            v-model:value="formState.status"
            placeholder="ËØ∑ÈÄâÊã©"
            style="width: 80px !important"
            allowClear
            :getPopupContainer="(triggerNode) => triggerNode.parentNode"
          >
            <a-select-option value="1">Ê≠£Â∏∏</a-select-option>
            <a-select-option value="0">ÂºÇÂ∏∏</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="ÊâπÊ¨°Âè∑">
          <a-select
            v-model:value="formState.activityId"
            placeholder="ËØ∑ÈÄâÊã©"
            style="width: 160px !important"
            allowClear
            :getPopupContainer="(triggerNode) => triggerNode.parentNode"
          >
          <a-select-option value="PHPRIMEOFFER202101194">PHPRIMEOFFER202101194</a-select-option>
            <a-select-option value="PHPRIMEOFFER202001885">PHPRIMEOFFER202001885</a-select-option>
            <a-select-option value="PHPRIMEOFFER202501019">PHPRIMEOFFER202501019</a-select-option>
          </a-select>
        </a-form-item>
        <!-- Êñ∞Â¢ûÊúÄÂ∞è‰ΩôÈ¢ùËæìÂÖ• -->
        <a-form-item label="ÊúÄÂ∞è‰ΩôÈ¢ù">
          <a-input-number
            v-model:value="formState.minBalance"
            placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ∞è‰ΩôÈ¢ù"
            style="width: 80px"
            :min="0"
            allowClear
          />
        </a-form-item>

        <!-- Êñ∞Â¢ûÊúÄÂ§ß‰ΩôÈ¢ùËæìÂÖ• -->
        <a-form-item label="ÊúÄÂ§ß‰ΩôÈ¢ù">
          <a-input-number
            v-model:value="formState.maxBalance"
            placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ§ß‰ΩôÈ¢ù"
            style="width: 80px"
            :min="0"
            allowClear
          />
        </a-form-item>

        <a-space>
          <a-button type="primary" html-type="submit">ÊêúÁ¥¢</a-button>
          <a-button @click="handleReset">ÈáçÁΩÆ</a-button>
          <!-- Êñ∞Â¢ûÊ∑ªÂä†Áî®Êà∑ÊåâÈíÆ -->
          <a-button type="primary" @click="addModalVisible = true"
            >Ê∑ªÂä†Áî®Êà∑</a-button
          >
          <!-- TokenÁõëÊéßÊéßÂà∂ÊåâÈíÆ -->
          <a-button 
            :type="tokenMonitor.isRunning ? 'primary' : 'default'"
            :danger="tokenMonitor.isRunning"
            :loading="tokenMonitor.loading"
            @click="toggleTokenMonitor"
            style="position: relative; z-index: 1;"
          >
            <template #icon>
              <span v-if="tokenMonitor.isRunning && tokenMonitor.websocketConnected" style="color: #52c41a;">‚óè</span>
              <span v-else-if="tokenMonitor.isRunning && !tokenMonitor.websocketConnected" style="color: #faad14;">‚óè</span>
              <span v-else style="color: #ff4d4f;">‚óè</span>
            </template>
            {{ getMonitorStatusText() }}
            <span v-if="tokenMonitor.checkProgress.total > 0 && !tokenMonitor.checkProgress.visible" 
                  style="margin-left: 8px; font-size: 12px; opacity: 0.8;"
                  @click.stop="showProgressFromButton">
              [{{ Math.round(tokenMonitor.checkProgress.percentage) }}%]
            </span>
          </a-button>
          <!-- ËØ≠Èü≥Êí≠Êä•ÂºÄÂÖ≥ -->
          <a-tooltip title="ÂºÄÂêØ/ÂÖ≥Èó≠TokenËøáÊúüËØ≠Èü≥ÊèêÈÜí">
            <a-button 
              :type="tokenMonitor.voiceEnabled ? 'primary' : 'default'"
              size="small"
              @click="toggleVoice"
            >
              {{ tokenMonitor.voiceEnabled ? 'üîä' : 'üîá' }}
            </a-button>
          </a-tooltip>
        </a-space>
      </a-form>
    </div>

    <!-- TokenÊ£ÄÊü•ËøõÂ∫¶Êù° -->
    <div v-if="tokenMonitor.checkProgress.visible" class="token-check-progress">
      <div class="progress-bar-container">
        <div class="progress-header">
          <span class="progress-title">üîç TokenÊ£ÄÊü•ËøõÂ∫¶ - Á¨¨{{ tokenMonitor.checkProgress.checkRound }}ËΩÆ</span>
          <div class="progress-actions">
            <a-button size="small" type="text" @click="minimizeProgress" v-if="!tokenMonitor.checkProgress.minimized">
              ÊúÄÂ∞èÂåñ
            </a-button>
            <a-button size="small" type="text" @click="showProgress" v-else>
              Â±ïÂºÄ
            </a-button>
            <a-button size="small" type="text" @click="hideProgress">
              ‚úï
            </a-button>
          </div>
        </div>
        <div v-if="!tokenMonitor.checkProgress.minimized" class="progress-content">
          <a-progress 
            :percent="Math.round(tokenMonitor.checkProgress.percentage)" 
            status="active"
            :show-info="false"
            size="small"
          />
          <div class="progress-info">
            <span>{{ tokenMonitor.checkProgress.current }} / {{ tokenMonitor.checkProgress.total }}</span>
            <span>ËøáÊúü: {{ tokenMonitor.checkProgress.expiredFound }}</span>
            <span>{{ Math.round(tokenMonitor.checkProgress.percentage) }}%</span>
          </div>
        </div>
        <div v-else class="progress-minimized">
          <span class="mini-progress">{{ Math.round(tokenMonitor.checkProgress.percentage) }}% ({{ tokenMonitor.checkProgress.current }}/{{ tokenMonitor.checkProgress.total }})</span>
        </div>
      </div>
    </div>

    <!-- Êï∞ÊçÆË°®Ê†º -->
    <a-card :bordered="false">
      <a-table
        :columns="columns"
        :dataSource="userList"
        :rowKey="(record) => record.id"
        :loading="loading"
        :pagination="false"
        :locale="{ emptyText: 'ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ' }"
        bordered
        tableLayout="fixed"
        size="middle"
        @change="handlePageChange"
      >
        <template #token="{ record }">
          <div class="line-clamp-3 overflow-hidden">{{ record.token }}</div>
        </template>
        <template #status="{ record }">
          <a-tag :color="record.status === '1' || record.status === 1 ? 'green' : 'red'">
            {{ record.status === '1' || record.status === 1 ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏' }}
          </a-tag>
        </template>
        <template #updateTime="{ record }">
          <span>{{ formatTime(record.updateTime) }}</span>
        </template>
        <template #action="{ record }">
          <a-space>
            <a-button type="link" size="small" @click="handleEdit(record)"
              >ÁºñËæëÁä∂ÊÄÅ</a-button
            >
            <a-button
              type="link"
              size="small"
              danger
              @click="handleDelete(record)"
              >Âà†Èô§</a-button
            >
          </a-space>
        </template>
      </a-table>
      <div style="margin-top: 10px;display: flex;justify-content: flex-end;">
        <a-pagination
          :current="pagination.current"
          :pageSize="pagination.pageSize"
          :total="pagination.total"
          @change="handlePageChange"
          @showSizeChange="handlePageSizeChange"
          showSizeChanger
          showQuickJumper
          size="small"
        />
      </div>
    </a-card>
    <!-- Ê∑ªÂä†Áî®Êà∑Ê®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="addModalVisible"
      title="Ê∑ªÂä†Áî®Êà∑"
      @ok="handleAddUser"
      @cancel="addModalVisible = false"
      okText="Ê∑ªÂä†"
      cancelText="ÂèñÊ∂à"
    >
      <a-form layout="vertical">
        <a-form-item label="ÊâãÊú∫Âè∑" required>
          <a-input
            v-model:value="addForm.phone"
            placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑"
            style="width: 300px"
          />
        </a-form-item>
        <a-form-item label="Token" required>
          <a-input
            v-model:value="addForm.token"
            placeholder="ËØ∑ËæìÂÖ•Token"
            style="width: 300px"
          />
        </a-form-item>
      </a-form>
    </a-modal>
    <!-- ÁºñËæëÁî®Êà∑Áä∂ÊÄÅÊ®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="editModalVisible"
      title="ÁºñËæëÁî®Êà∑Áä∂ÊÄÅ"
      @ok="handleEditSubmit"
      @cancel="editModalVisible = false"
      okText="‰øùÂ≠ò"
      cancelText="ÂèñÊ∂à"
    >
      <a-form layout="vertical">
        <a-form-item label="Áî®Êà∑Token">
          <a-input
            v-model:value="editForm.token"
            placeholder="Áî®Êà∑Token"
            style="width: 100%"
            disabled
          />
        </a-form-item>
        <a-form-item label="ÊâãÊú∫Âè∑">
          <a-input
            v-model:value="editForm.phone"
            placeholder="ÊâãÊú∫Âè∑"
            style="width: 100%"
            disabled
          />
        </a-form-item>
        <a-form-item label="Áî®Êà∑Áä∂ÊÄÅ" required>
          <a-select
            v-model:value="editForm.status"
            placeholder="ËØ∑ÈÄâÊã©Áî®Êà∑Áä∂ÊÄÅ"
            style="width: 100%"
            :getPopupContainer="(triggerNode) => triggerNode.parentNode"
          >
            <a-select-option value="1">Ê≠£Â∏∏</a-select-option>
            <a-select-option value="0">ÂºÇÂ∏∏</a-select-option>
          </a-select>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- TokenËøáÊúüÈÄöÁü•Ê®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="expiredNotificationVisible"
      title="‚ö†Ô∏è TokenËøáÊúüÊèêÈÜí"
      :footer="null"
      :closable="false"
      :maskClosable="false"
      centered
      width="500px"
      :destroy-on-close="true"
    >
      <div v-if="expiredNotification && expiredNotification.users" class="expired-notification">
        <div class="notification-icon">
          <span style="color: #faad14; font-size: 48px;">‚ö†Ô∏è</span>
        </div>
        <div class="notification-content">
          <h3>ÂèëÁé∞ {{ expiredNotification.count || 0 }} ‰∏™Áî®Êà∑TokenËøáÊúü</h3>
          <div class="expired-users" v-if="expiredNotification.users.length > 0">
            <div 
              v-for="(user, index) in expiredNotification.users" 
              :key="`expired-user-${index}-${user.user_id || user.phone || Date.now()}`"
              class="expired-user-item"
            >
              <a-tag color="red">{{ user.phone || 'Êú™Áü•ÊâãÊú∫Âè∑' }}</a-tag>
              <span class="user-token">{{ user.token && user.token.length > 20 ? user.token.substring(0, 20) + '...' : (user.token || 'Êú™Áü•Token') }}</span>
            </div>
          </div>
          <div class="notification-footer">
            <p class="manual-close-text">ËØ∑ÊâãÂä®ÂÖ≥Èó≠Ê≠§ÈÄöÁü•</p>
          </div>
        </div>
      </div>
      <div class="notification-actions">
        <a-button type="primary" @click="closeExpiredNotification">
          Áü•ÈÅì‰∫Ü
        </a-button>
        <a-button @click="viewExpiredDetails">
          Êü•ÁúãËØ¶ÊÉÖ
        </a-button>
      </div>
    </a-modal>
  </div>
</template>

<script setup>
import {
  getUserList,
  addUser,
  deleteUser,
  switchStatus,
  checkVip,
  getBalance,
  getVgold,
  queryCoupon,
  getTokenMonitorStatus,
  startTokenMonitor,
  stopTokenMonitor,
  getExpiredUsers,
  pollTokenMonitor,
  getPollConfig,
} from "@/api";
import { message, Modal } from "ant-design-vue"; // Add Modal import
import { reactive, ref, onMounted, onUnmounted } from "vue";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import timezone from "dayjs/plugin/timezone";
import { WebSocketCompat } from "@/utils/HttpPoller";

// ÂêØÁî®dayjsÊèí‰ª∂
dayjs.extend(utc);
dayjs.extend(timezone);

// Ë°®ÂçïÁä∂ÊÄÅ
const formState = reactive({
  phone: "",
  vip: "",
  activityId: "",
  status: "",
  minBalance: null, // Êñ∞Â¢ûÊúÄÂ∞è‰ΩôÈ¢ù
  maxBalance: null, // Êñ∞Â¢ûÊúÄÂ§ß‰ΩôÈ¢ù
});

// Ë°®Ê†ºÊï∞ÊçÆ
const userList = ref([]);
const loading = ref(false);
const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  pageSizeOptions: ["10", "20", "50", "100"],
});

// TokenÁõëÊéßÁõ∏ÂÖ≥Áä∂ÊÄÅ
const tokenMonitor = reactive({
  isRunning: false,
  loading: false,
  totalUsers: 0,
  expiredCount: 0,
  lastCheck: null,
  websocketConnected: false, // Êñ∞Â¢ûWebSocketËøûÊé•Áä∂ÊÄÅ
  voiceEnabled: true, // ËØ≠Èü≥Êí≠Êä•ÂºÄÂÖ≥
  alwaysNotify: true, // ÊØèËΩÆÊ£ÄÊü•ÂÆåÊàêÈÉΩÈÄöÁü•
  // Ê£ÄÊü•ËøõÂ∫¶Áõ∏ÂÖ≥
  checkProgress: {
    visible: false,
    minimized: false,
    current: 0,
    total: 0,
    percentage: 0,
    checkRound: 0,
    expiredFound: 0,
  },
});

// HTTPËΩÆËØ¢ËøûÊé• (Êõø‰ª£WebSocket)
let httpPoller = null;
let statusCheckTimer = null; // ÂÆöÊúüÊ£ÄÊü•ÂêéÁ´ØÁä∂ÊÄÅÁöÑÂÆöÊó∂Âô®

// TokenËøáÊúüÈÄöÁü•Áõ∏ÂÖ≥Áä∂ÊÄÅ
const expiredNotificationVisible = ref(false);
const expiredNotification = reactive({
  count: 0,
  users: [],
});
const notificationCountdown = ref(0); // ‰∏çÂÜçËá™Âä®ÂÄíËÆ°Êó∂
const notificationProgress = ref(0);
let countdownTimer = null;

// ÂàóÈÖçÁΩÆ
const columns = [
  {
    title: "token",
    dataIndex: "token",
    minWidth: 200,
    slots: { customRender: "token" },
  },
  {
    title: "ÊâãÊú∫Âè∑",
    dataIndex: "phone",
    width: 180,
  },
  {
    title: "‰ΩôÈ¢ù",
    dataIndex: "balance",
    width: 180,
  },
  {
    title: "ÊòØÂê¶Â∞ä‰∫´Âç°",
    dataIndex: "vip",
    width: 150,
    customRender: ({ record }) => {
      return record.vip === 1 ? "ÊòØ" : "Âê¶";
    },
  },
  {
    title: "ÊâπÊ¨°Âè∑",
    dataIndex: "activityId",
    minWidth: 130,
  },
  {
    title: "Êõ¥Êñ∞Êó∂Èó¥",
    dataIndex: "updateTime",
    width: 150,
    slots: { customRender: "updateTime" },
  },
  {
    title: "Áî®Êà∑Áä∂ÊÄÅ",
    dataIndex: "status",
    width: 150,
    slots: { customRender: "status" },
  },

  {
    title: "Êìç‰Ωú",
    dataIndex: "action",
    width: 150,
    slots: { customRender: "action" },
  },
];

// ÊêúÁ¥¢ÈÄªËæë
const handleSearch = async (payload = {}) => {
  loading.value = true;
  try {
    const params = {
      ...formState,
      pageNum: 1,
      pageSize: pagination.pageSize,
      ...payload,
    };
    const res = await getUserList(params);
    userList.value = res.data;
    pagination.total = res.count;
    pagination.current = +res.pageNum;
    pagination.pageSize = +res.pageSize;
  } catch (err) {
    message.error("Êü•ËØ¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï");
  } finally {
    loading.value = false;
  }
};

// Êó∂Èó¥Ê†ºÂºèÂåñÂáΩÊï∞ - Â∞ÜGMTÊó∂Èó¥ËΩ¨Êç¢‰∏∫Âåó‰∫¨Êó∂Èó¥
const formatTime = (time) => {
  if (!time) return '-';
  
  try {
    // Â∞ÜGMTÊó∂Èó¥ËΩ¨Êç¢‰∏∫Âåó‰∫¨Êó∂Èó¥ (UTC+8)
    return dayjs.utc(time).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss');
  } catch (error) {
    console.error('Êó∂Èó¥Ê†ºÂºèÂåñÈîôËØØ:', error);
    return time; // Â¶ÇÊûúËΩ¨Êç¢Â§±Ë¥•ÔºåËøîÂõûÂéüÂßãÊó∂Èó¥
  }
};

// ÈáçÁΩÆË°®Âçï
const handleReset = () => {
  formState.phone = "";
  formState.vip = "";
  formState.activityId = "";
  formState.status = "";
  formState.minBalance = null; // Êñ∞Â¢ûÈáçÁΩÆÊúÄÂ∞è‰ΩôÈ¢ù
  formState.maxBalance = null; // Êñ∞Â¢ûÈáçÁΩÆÊúÄÂ§ß‰ΩôÈ¢ù
  handleSearch({
    pageNum: 1,
  });
};

const handleDelete = async (record) => {
  Modal.confirm({
    title: "Á°ÆËÆ§Âà†Èô§",
    content: "ÊòØÂê¶Á°ÆËÆ§Âà†Èô§ËØ•Áî®Êà∑ÔºüÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç",
    okText: "Á°ÆËÆ§",
    okType: "danger",
    cancelText: "ÂèñÊ∂à",
    onOk: async () => {
      try {
        await deleteUser({ id: record.id });
        message.success("Âà†Èô§ÊàêÂäü");
        handleSearch({
          pageNum: pagination.current,
        });
      } catch (err) {
        message.error("Âà†Èô§Â§±Ë¥•");
      }
    },
    onCancel: () => {
      message.info("Â∑≤ÂèñÊ∂àÂà†Èô§");
    },
  });
};

// ÂàùÂßãÂåñÂä†ËΩΩ
onMounted(() => {
  console.log('üöÄ Áî®Êà∑ÂàóË°®È°µÈù¢Â∑≤ÊåÇËΩΩ');
  console.log('ÂàùÂßãtokenMonitorÁä∂ÊÄÅ:', tokenMonitor);
  
  // ËØªÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑËÆæÁΩÆ
  const savedVoiceEnabled = localStorage.getItem('tokenMonitorVoiceEnabled');
  if (savedVoiceEnabled !== null) {
    tokenMonitor.voiceEnabled = savedVoiceEnabled === 'true';
  }
  
  const savedAlwaysNotify = localStorage.getItem('tokenMonitorAlwaysNotify');
  if (savedAlwaysNotify !== null) {
    tokenMonitor.alwaysNotify = savedAlwaysNotify === 'true';
  }
  
  handleSearch();
  // Ëé∑ÂèñTokenÁõëÊéßÁä∂ÊÄÅÔºåÂπ∂Ê†πÊçÆÁä∂ÊÄÅËá™Âä®ÊÅ¢Â§çËøûÊé•
  getMonitorStatus();
  
  // ÂºÄÂßãÂÆöÊúüÊ£ÄÊü•ÂêéÁ´ØÁä∂ÊÄÅ
  startStatusCheck();
  
  console.log('‚úÖ È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
});

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
onUnmounted(() => {
  disconnectHttpPoller();
  stopStatusCheck(); // ÂÅúÊ≠¢ÂÆöÊúüÁä∂ÊÄÅÊ£ÄÊü•
  if (countdownTimer) {
    clearInterval(countdownTimer);
  }
});

// Ê∑ªÂä†Áî®Êà∑Áõ∏ÂÖ≥Áä∂ÊÄÅ
const addModalVisible = ref(false);
const addForm = reactive({
  phone: "",
  token: "",
});

// Ê∑ªÂä†Áî®Êà∑Êèê‰∫§ÈÄªËæë
const handleAddUser = async () => {
  if (!addForm.phone || !addForm.token) {
    message.warning("ËØ∑Â°´ÂÜôÂÆåÊï¥ÊâãÊú∫Âè∑ÂíåToken");
    return;
  }
  try {
    await addUser(addForm); // Ë∞ÉÁî®Ê∑ªÂä†Áî®Êà∑Êé•Âè£
    message.success("Áî®Êà∑Ê∑ªÂä†ÊàêÂäü");
    addModalVisible.value = false;
    handleSearch({
      pageNum: 1,
    }); // Âà∑Êñ∞Á¨¨‰∏ÄÈ°µÊï∞ÊçÆ
    addForm.phone = ""; // Ê∏ÖÁ©∫Ë°®Âçï
    addForm.token = "";
  } catch (err) {
    message.error(err.toString());
  }
};

// ÁºñËæëÁî®Êà∑Áõ∏ÂÖ≥Áä∂ÊÄÅ
const editModalVisible = ref(false);
const editForm = reactive({
  phone: "",
  token: "",
  status: "", // Changed from vip to status
});

// ÁºñËæëÁî®Êà∑ÁÇπÂáª‰∫ã‰ª∂ÔºàÊõøÊç¢ÂéüÊúâhandleEditÔºâ
const handleEdit = (record) => {
  editForm.phone = record.phone;
  editForm.token = record.token;
  editForm.status = record.status.toString(); // Changed from vip to status
  editModalVisible.value = true;
};

// ÁºñËæëÁî®Êà∑Êèê‰∫§ÈÄªËæë
const handleEditSubmit = async () => {
  if (editForm.status === "") {
    message.warning("ËØ∑ÈÄâÊã©Áî®Êà∑Áä∂ÊÄÅ");
    return;
  }
  try {
    // Ë∞ÉÁî®ÂàáÊç¢Áî®Êà∑Áä∂ÊÄÅÊé•Âè£ÔºåÂè™ÈúÄË¶Å‰º†ÈÄítokenÂèÇÊï∞
    await switchStatus({ token: editForm.token });
    message.success("Áî®Êà∑Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü");
    editModalVisible.value = false;
    // Âà∑Êñ∞ÂΩìÂâçÈ°µÊï∞ÊçÆ
    handleSearch({
      pageNum: pagination.current,
    });
  } catch (err) {
    message.error("Áî®Êà∑Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï");
    console.error("Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÂ§±Ë¥•:", err);
  }
};
const handlePageChange = (pageNum, pageSize) => {
  handleSearch({
    pageNum: pageNum,
    pageSize,
  });
};

const handlePageSizeChange = (current, size) => {};

// ========== TokenÁõëÊéßÂäüËÉΩ ==========

// Ëé∑ÂèñÁõëÊéßÁä∂ÊÄÅÊñáÊú¨
const getMonitorStatusText = () => {
  if (tokenMonitor.isRunning && tokenMonitor.websocketConnected) {
    return 'TokenÁõëÊéß(ËøêË°å‰∏≠)';
  } else if (tokenMonitor.isRunning && !tokenMonitor.websocketConnected) {
    return 'TokenÁõëÊéß(ËøûÊé•‰∏≠...)';
  } else {
    return 'TokenÁõëÊéß(Â∑≤ÂÅúÊ≠¢)';
  }
};

// ÊòæÁ§∫ËøõÂ∫¶Êù°ÔºàÂ¶ÇÊûúÊúâËøõÂ∫¶Êï∞ÊçÆÁöÑËØùÔºâ
const showProgressFromButton = () => {
  if (tokenMonitor.checkProgress.total > 0) {
    tokenMonitor.checkProgress.visible = true;
    tokenMonitor.checkProgress.minimized = false;
  }
};

// ÂàáÊç¢ËØ≠Èü≥Êí≠Êä•ÂºÄÂÖ≥
const toggleVoice = () => {
  tokenMonitor.voiceEnabled = !tokenMonitor.voiceEnabled;
  const status = tokenMonitor.voiceEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
  message.info(`TokenËøáÊúüËØ≠Èü≥ÊèêÈÜí${status}`);
  
  // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
  localStorage.setItem('tokenMonitorVoiceEnabled', tokenMonitor.voiceEnabled.toString());
  
  // Â¶ÇÊûúÂºÄÂêØËØ≠Èü≥ÔºåÊí≠ÊîæÊµãËØïÈü≥
  if (tokenMonitor.voiceEnabled) {
    setTimeout(() => {
      speakTest();
    }, 500);
  }
};

// ÊµãËØïËØ≠Èü≥Êí≠Êä•
const speakTest = () => {
  try {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance('ËØ≠Èü≥ÊèêÈÜíÂ∑≤ÂºÄÂêØ');
      utterance.lang = 'zh-CN';
      utterance.rate = 0.8;
      utterance.volume = 0.6;
      window.speechSynthesis.speak(utterance);
    }
  } catch (error) {
    console.error('ÊµãËØïËØ≠Èü≥Êí≠Êä•Â§±Ë¥•:', error);
  }
};

// ÂºÄÂßãÂÆöÊúüÊ£ÄÊü•ÂêéÁ´ØÁä∂ÊÄÅ
const startStatusCheck = () => {
  // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°ÂêéÁ´ØÁä∂ÊÄÅÔºåÁ°Æ‰øùÂâçÂêéÁ´ØÂêåÊ≠•
  statusCheckTimer = setInterval(async () => {
    console.log('üîÑ ÂÆöÊúüÊ£ÄÊü•ÂêéÁ´ØÁõëÊéßÁä∂ÊÄÅ...');
    await getMonitorStatus();
  }, 30000);
};

// ÂÅúÊ≠¢ÂÆöÊúüÊ£ÄÊü•
const stopStatusCheck = () => {
  if (statusCheckTimer) {
    clearInterval(statusCheckTimer);
    statusCheckTimer = null;
    console.log('‚èπÔ∏è Â∑≤ÂÅúÊ≠¢ÂÆöÊúüÁä∂ÊÄÅÊ£ÄÊü•');
  }
};

// Ëé∑ÂèñTokenÁõëÊéßÁä∂ÊÄÅ
const getMonitorStatus = async () => {
  console.log('üì° Ê≠£Âú®Ëé∑ÂèñTokenÁõëÊéßÁä∂ÊÄÅ...');
  try {
    const res = await getTokenMonitorStatus();
    console.log('üì° Ëé∑ÂèñÁõëÊéßÁä∂ÊÄÅÂìçÂ∫î:', res);
    if (res.code === 200) {
      const monitor = res.data.monitor || {};
      const websocketInfo = res.data.websocket || {};
      
      // Êõ¥Êñ∞ÁõëÊéßÁä∂ÊÄÅ
      tokenMonitor.isRunning = monitor.is_running || false;
      tokenMonitor.totalUsers = monitor.total_users || 0;
      tokenMonitor.expiredCount = monitor.total_expired || 0;
      tokenMonitor.lastCheck = monitor.last_check_time;
      
      console.log('‚úÖ ÁõëÊéßÁä∂ÊÄÅÊõ¥Êñ∞ÂÆåÊàê:', tokenMonitor);
      
      // Â¶ÇÊûúÂêéÁ´ØÁõëÊéßÊ≠£Âú®ËøêË°åÔºå‰ΩÜÂâçÁ´ØWebSocketÊú™ËøûÊé•ÔºåÂàôËá™Âä®ËøûÊé•
      if (tokenMonitor.isRunning && !tokenMonitor.websocketConnected) {
        console.log('üîÑ Ê£ÄÊµãÂà∞ÂêéÁ´ØÁõëÊéßËøêË°å‰∏≠ÔºåËá™Âä®ËøûÊé•WebSocket...');
        setTimeout(() => {
          connectHttpPoller();
        }, 1000);
      }
      
      // Â¶ÇÊûúÂêéÁ´ØÁõëÊéßÂ∑≤ÂÅúÊ≠¢Ôºå‰ΩÜÂâçÁ´ØWebSocketËøòËøûÁùÄÔºåÂàôÊñ≠ÂºÄËøûÊé•
      if (!tokenMonitor.isRunning && tokenMonitor.websocketConnected) {
        console.log('üîÑ Ê£ÄÊµãÂà∞ÂêéÁ´ØÁõëÊéßÂ∑≤ÂÅúÊ≠¢ÔºåÊñ≠ÂºÄWebSocketËøûÊé•...');
        disconnectHttpPoller();
      }
    } else {
      console.warn('‚ö†Ô∏è Ëé∑ÂèñÁõëÊéßÁä∂ÊÄÅÂ§±Ë¥•:', res);
    }
  } catch (err) {
    console.error('‚ùå Ëé∑ÂèñÁõëÊéßÁä∂ÊÄÅÂ§±Ë¥•:', err);
  }
};

// ÂàáÊç¢TokenÁõëÊéßÁä∂ÊÄÅ
const toggleTokenMonitor = async () => {
  console.log('ÁÇπÂáª‰∫ÜTokenÁõëÊéßÊåâÈíÆÔºåÂΩìÂâçÁä∂ÊÄÅ:', tokenMonitor.isRunning);
  tokenMonitor.loading = true;
  
  try {
    if (tokenMonitor.isRunning) {
      // ÂÅúÊ≠¢ÁõëÊéßÔºöÂÖàÊñ≠ÂºÄWebSocketÔºåÂÜçÂÅúÊ≠¢ÂêéÁ´ØÁõëÊéß
      console.log('Ê≠£Âú®ÂÅúÊ≠¢TokenÁõëÊéß...');
      disconnectHttpPoller();
      
      const res = await stopTokenMonitor();
      if (res.code === 200) {
        message.success('TokenÁõëÊéßÂ∑≤ÂÅúÊ≠¢');
        tokenMonitor.isRunning = false;
      } else {
        // Âç≥‰ΩøÂÅúÊ≠¢Â§±Ë¥•Ôºå‰πüË¶ÅÊõ¥Êñ∞Áä∂ÊÄÅÔºåÂèØËÉΩÂêéÁ´ØÂ∑≤ÁªèÂÅúÊ≠¢‰∫Ü
        console.warn('ÂÅúÊ≠¢TokenÁõëÊéßAPIÂ§±Ë¥•Ôºå‰ΩÜ‰ªçÊõ¥Êñ∞ÂâçÁ´ØÁä∂ÊÄÅ:', res);
        message.warning('TokenÁõëÊéßÂèØËÉΩÂ∑≤ÂÅúÊ≠¢ÔºåËØ∑Âà∑Êñ∞È°µÈù¢Á°ÆËÆ§Áä∂ÊÄÅ');
        tokenMonitor.isRunning = false;
      }
    } else {
      // ÂêØÂä®ÁõëÊéßÔºöÂÖàÊ£ÄÊü•ÂêéÁ´ØÁä∂ÊÄÅÔºåÈÅøÂÖçÈáçÂ§çÂêØÂä®
      console.log('Ê≠£Âú®ÂêØÂä®TokenÁõëÊéß...');
      
      // ÂÖàÊ£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅÔºåÈÅøÂÖçÈáçÂ§çÂêØÂä®
      await getMonitorStatus();
      
      if (tokenMonitor.isRunning) {
        // ÂêéÁ´ØÂ∑≤ÁªèÂú®ËøêË°åÔºåÂè™ÈúÄËøûÊé•WebSocket
        message.info('TokenÁõëÊéßÂ∑≤Âú®ËøêË°åÔºåÊ≠£Âú®ËøûÊé•WebSocket...');
        if (!tokenMonitor.websocketConnected) {
          setTimeout(() => {
            connectHttpPoller();
          }, 500);
        }
      } else {
        // ÂêéÁ´ØÊú™ËøêË°åÔºåÂêØÂä®ÁõëÊéß
        const res = await startTokenMonitor();
        if (res.code === 200) {
          message.success('TokenÁõëÊéßÂ∑≤ÂêØÂä®ÔºåÊ≠£Âú®ËøûÊé•WebSocket...');
          tokenMonitor.isRunning = true;
          
          // Âª∂Ëøü‰∏ÄÁÇπÂÜçËøûÊé•WebSocketÔºåÁ°Æ‰øùÂêéÁ´ØÊúçÂä°ÂÆåÂÖ®ÂêØÂä®
          setTimeout(() => {
            connectHttpPoller();
          }, 1000);
        } else {
          message.error(res.message || 'TokenÁõëÊéßÂêØÂä®Â§±Ë¥•');
          console.error('ÂêØÂä®TokenÁõëÊéßÂ§±Ë¥•:', res);
        }
      }
    }
  } catch (err) {
    message.error('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
    console.error('ÂàáÊç¢ÁõëÊéßÁä∂ÊÄÅÂ§±Ë¥•:', err);
  } finally {
    tokenMonitor.loading = false;
  }
};

// HTTPËΩÆËØ¢ËøûÊé• (Êõø‰ª£WebSocket)
const connectHttpPoller = () => {
  if (httpPoller) {
    httpPoller.stop();
  }
  
  console.log('Ê≠£Âú®ÂêØÂä®HTTPËΩÆËØ¢...');
  tokenMonitor.websocketConnected = false;
  
  // Ê∑ªÂä†ÁΩëÁªúÊ£ÄÊµã
  console.log('üåê ÂΩìÂâçÁΩëÁªú‰ø°ÊÅØ:', {
    userAgent: navigator.userAgent,
    onLine: navigator.onLine,
    connection: navigator.connection ? {
      effectiveType: navigator.connection.effectiveType,
      downlink: navigator.connection.downlink,
      rtt: navigator.connection.rtt
    } : '‰∏çÊîØÊåÅ'
  });
  
  try {
    // ‰ΩøÁî®WebSocketÂÖºÂÆπÂ±Ç
    httpPoller = new WebSocketCompat('http://api', []);
    
    httpPoller.onOpen = () => {
      console.log('‚úÖ HTTPËΩÆËØ¢ËøûÊé•ÊàêÂäü');
      tokenMonitor.websocketConnected = true;
      message.success('HTTPËΩÆËØ¢ËøûÊé•ÊàêÂäü');
    };
    
    httpPoller.onMessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      } catch (err) {
        console.error('Ëß£ÊûêHTTPËΩÆËØ¢Ê∂àÊÅØÂ§±Ë¥•:', err);
      }
    };
    
    httpPoller.onClose = (event) => {
      console.log('HTTPËΩÆËØ¢ËøûÊé•ÂÖ≥Èó≠Ôºåcode:', event.code, 'reason:', event.reason);
      tokenMonitor.websocketConnected = false;
      
      // Âè™ÊúâÂú®ÁõëÊéßËøêË°å‰∏î‰∏çÊòØ‰∏ªÂä®ÂÖ≥Èó≠ÁöÑÊÉÖÂÜµ‰∏ãÊâçÈáçËøû
      if (tokenMonitor.isRunning && event.code !== 1000) {
        console.log('HTTPËΩÆËØ¢ÊÑèÂ§ñÊñ≠ÂºÄÔºå5ÁßíÂêéÂ∞ùËØïÈáçËøû...');
        setTimeout(connectHttpPoller, 5000);
      }
    };
    
    httpPoller.onError = (error) => {
      console.error('‚ùå HTTPËΩÆËØ¢ËøûÊé•ÈîôËØØ:', error);
      tokenMonitor.websocketConnected = false;
      
      // Ê£ÄÊµãÁΩëÁªúËøûÈÄöÊÄß
      if (!navigator.onLine) {
        message.error('ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
      } else {
        message.error(`HTTPËΩÆËØ¢ËøûÊé•Â§±Ë¥•ÔºåÊ≠£Âú®ÈáçËØï...`);
      }
    };
    
    // ÂêØÂä®ËΩÆËØ¢
    httpPoller.start();
    
  } catch (err) {
    console.error('ÂàõÂª∫HTTPËΩÆËØ¢ËøûÊé•Â§±Ë¥•:', err);
    tokenMonitor.websocketConnected = false;
    message.error('ÂàõÂª∫HTTPËΩÆËØ¢ËøûÊé•Â§±Ë¥•');
  }
};

// Êñ≠ÂºÄHTTPËΩÆËØ¢ËøûÊé•
const disconnectHttpPoller = () => {
  console.log('Êñ≠ÂºÄHTTPËΩÆËØ¢ËøûÊé•...');
  
  if (httpPoller) {
    httpPoller.stop();
    httpPoller = null;
  }
  
  tokenMonitor.websocketConnected = false;
  console.log('HTTPËΩÆËØ¢ËøûÊé•Â∑≤Êñ≠ÂºÄ');
};

// Â§ÑÁêÜWebSocketÊ∂àÊÅØ
const handleWebSocketMessage = (data) => {
  console.log('Êî∂Âà∞WebSocketÊ∂àÊÅØ:', data);
  
  switch (data.type) {
    case 'welcome':
      console.log('WebSocketÊ¨¢ËøéÊ∂àÊÅØ:', data.message);
      break;
      
    case 'token_expired':
      handleTokenExpiredNotification(data);
      break;
      
    case 'current_status':
      updateMonitorStatus(data);
      break;
      
    case 'pong':
      console.log('ÂøÉË∑≥ÂìçÂ∫î:', data.latency_ms + 'ms');
      break;
      
    case 'check_progress':
      handleCheckProgress(data);
      break;
      
    case 'check_completed':
      handleCheckCompleted(data);
      break;
      
    case 'check_started':
      handleCheckStarted(data);
      break;
      
    default:
      console.log('Êú™Áü•Ê∂àÊÅØÁ±ªÂûã:', data.type);
  }
};

// Â§ÑÁêÜÊ£ÄÊü•ÂºÄÂßãÊ∂àÊÅØ
const handleCheckStarted = (data) => {
  console.log('üîÑ Ê£ÄÊü•ÂºÄÂßã:', data);
  // ÈáçÁΩÆËøõÂ∫¶Êù°Áä∂ÊÄÅ
  if (tokenMonitor.checkProgress.visible) {
    tokenMonitor.checkProgress.current = 0;
    tokenMonitor.checkProgress.percentage = 0;
    tokenMonitor.checkProgress.checkRound = data.check_round || 0;
  }
};

// Â§ÑÁêÜÊ£ÄÊü•ÂÆåÊàêÊ∂àÊÅØ
const handleCheckCompleted = (data) => {
  console.log('‚úÖ Ê£ÄÊü•ÂÆåÊàê:', data);
  
  // Â¶ÇÊûúÂºÄÂêØ‰∫ÜÊØèËΩÆÊ£ÄÊü•ÈÉΩÈÄöÁü•Ôºå‰∏îÊúâËøáÊúüÁî®Êà∑
  if (tokenMonitor.alwaysNotify && tokenMonitor.expiredCount > 0) {
    console.log(`üîî Ê£ÄÊü•ÂÆåÊàêÔºåÂèëÁé∞${tokenMonitor.expiredCount}‰∏™ËøáÊúüÁî®Êà∑ÔºåÂáÜÂ§áÊí≠Êä•`);
    
    // ‰ªéÂêéÁ´ØËé∑ÂèñÂΩìÂâçËøáÊúüÁî®Êà∑ÂàóË°®Âπ∂Êí≠Êä•
    getAndNotifyExpiredUsers();
  } else if (tokenMonitor.expiredCount > 0) {
    console.log(`üîï Ê£ÄÊü•ÂÆåÊàêÔºåÊúâ${tokenMonitor.expiredCount}‰∏™ËøáÊúüÁî®Êà∑Ôºå‰ΩÜÂ∑≤ÂÖ≥Èó≠ÊØèËΩÆÈÄöÁü•`);
  } else {
    console.log('‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºåÊó†ËøáÊúüÁî®Êà∑');
  }
  
  // 3ÁßíÂêéÈöêËóèËøõÂ∫¶Êù°
  if (tokenMonitor.checkProgress.visible) {
    setTimeout(() => {
      tokenMonitor.checkProgress.visible = false;
    }, 3000);
  }
};

// Ëé∑ÂèñÂπ∂Êí≠Êä•ËøáÊúüÁî®Êà∑
const getAndNotifyExpiredUsers = async () => {
  try {
    console.log('üì° Ëé∑ÂèñËøáÊúüÁî®Êà∑ÂàóË°®...');
    const res = await getExpiredUsers();
    
    if (res.code === 200 && res.data && res.data.users) {
      const users = res.data.users;
      const count = res.data.count || users.length;
      
      console.log(`üìã Ëé∑ÂèñÂà∞${count}‰∏™ËøáÊúüÁî®Êà∑:`, users);
      
      if (count > 0 && users.length > 0) {
        // Á¥ØÁßØËøáÊúüÁî®Êà∑Ôºå‰∏çÊõøÊç¢‰πãÂâçÁöÑ
        if (expiredNotificationVisible.value) {
          // Â¶ÇÊûúÂºπÁ™óÂ∑≤ÁªèÊòæÁ§∫ÔºåÁ¥ØÁßØÊñ∞ÁöÑËøáÊúüÁî®Êà∑
          const existingPhones = new Set(expiredNotification.users.map(u => u.phone));
          const newUsers = users.filter(u => !existingPhones.has(u.phone));
          
          if (newUsers.length > 0) {
            expiredNotification.users.push(...newUsers);
            expiredNotification.count = expiredNotification.users.length;
            console.log(`üö® ‰ªéAPIÁ¥ØÁßØÊñ∞ÁöÑËøáÊúüÁî®Êà∑ ${newUsers.length} ‰∏™ÔºåÊÄªËÆ° ${expiredNotification.count} ‰∏™`);
          }
        } else {
          // Â¶ÇÊûúÂºπÁ™óÊú™ÊòæÁ§∫ÔºåÁõ¥Êé•ËÆæÁΩÆÊñ∞Êï∞ÊçÆ
          expiredNotification.count = count;
          expiredNotification.users = users;
          console.log(`üö® ‰ªéAPIËé∑ÂèñÂà∞${count}‰∏™ËøáÊúüÁî®Êà∑ÔºåÂáÜÂ§áÊí≠Êä•`);
        }
        
        // ÊòæÁ§∫ÂºπÁ™óÈÄöÁü•
        showExpiredNotification();
        
        // ËØ≠Èü≥Êí≠Êä•Ôºà‰ªÖÂú®ÂºÄÂêØÊó∂Ôºâ
        if (tokenMonitor.voiceEnabled) {
          console.log('üîä ÂºÄÂßãËØ≠Èü≥Êí≠Êä•ËøáÊúüÁî®Êà∑...');
          speakExpiredNotification(users);
        } else {
          console.log('üîá ËØ≠Èü≥Êí≠Êä•Â∑≤ÂÖ≥Èó≠ÔºåË∑≥ËøáÊí≠Êä•');
        }
      }
    }
  } catch (error) {
    console.error('‚ùå Ëé∑ÂèñËøáÊúüÁî®Êà∑Â§±Ë¥•:', error);
  }
};

// Â§ÑÁêÜTokenÊ£ÄÊü•ËøõÂ∫¶
const handleCheckProgress = (data) => {
  console.log('TokenÊ£ÄÊü•ËøõÂ∫¶:', data);
  
  // ÊòæÁ§∫ËøõÂ∫¶Êù°
  tokenMonitor.checkProgress.visible = true;
  tokenMonitor.checkProgress.current = data.current || 0;
  tokenMonitor.checkProgress.total = data.total || 0;
  tokenMonitor.checkProgress.percentage = data.percentage || 0;
  tokenMonitor.checkProgress.checkRound = data.check_round || 0;
  tokenMonitor.checkProgress.expiredFound = data.expired_found || 0;
  
  // Â¶ÇÊûúÊ£ÄÊü•ÂÆåÊàêÔºàËøõÂ∫¶100%ÔºâÔºå3ÁßíÂêéËá™Âä®ÈöêËóèËøõÂ∫¶Êù°
  if (data.percentage >= 100) {
    setTimeout(() => {
      tokenMonitor.checkProgress.visible = false;
    }, 3000);
  }
};

// ÈöêËóèËøõÂ∫¶Êù°
const hideProgress = () => {
  tokenMonitor.checkProgress.visible = false;
};

// ÊúÄÂ∞èÂåñËøõÂ∫¶Êù°
const minimizeProgress = () => {
  tokenMonitor.checkProgress.minimized = true;
};

// Â±ïÂºÄËøõÂ∫¶Êù°
const showProgress = () => {
  tokenMonitor.checkProgress.minimized = false;
};

// ËØ≠Èü≥Êí≠Êä•ÂäüËÉΩ
const speakExpiredNotification = (users) => {
  console.log('üîä ÂºÄÂßãËØ≠Èü≥Êí≠Êä•ÔºåÁî®Êà∑Êï∞Èáè:', users.length);
  try {
    // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ≠Èü≥ÂêàÊàê
    if ('speechSynthesis' in window) {
      // ÊúÄÂ§öÊí≠Êä•Ââç5‰∏™ÊâãÊú∫Âè∑ÔºåÈÅøÂÖçÊí≠Êä•Êó∂Èó¥ËøáÈïø
      const maxCount = 5;
      const displayUsers = users.slice(0, maxCount);
      const phoneNumbers = displayUsers.map(user => {
        const phone = user.phone || 'Êú™Áü•Âè∑Á†Å';
        // Áõ¥Êé•Êí≠Êä•ÂÆåÊï¥ÊâãÊú∫Âè∑Ôºå‰∏çÂÅö‰ªª‰ΩïÂ§ÑÁêÜ
        return phone;
      }).join('Ôºå');
      
      let text;
      if (users.length <= maxCount) {
        text = `Ê≥®ÊÑèÔºå‰ª•‰∏ãÊâãÊú∫Âè∑TokenÂ∑≤ËøáÊúüÔºö${phoneNumbers}ÔºåËØ∑ÂèäÊó∂Â§ÑÁêÜ`;
      } else {
        text = `Ê≥®ÊÑèÔºå‰ª•‰∏ãÊâãÊú∫Âè∑TokenÂ∑≤ËøáÊúüÔºö${phoneNumbers}ÔºåËøòÊúâ${users.length - maxCount}‰∏™ÔºåËØ∑ÂèäÊó∂Â§ÑÁêÜ`;
      }
      
      console.log(`üîä ÂáÜÂ§áÊí≠Êä•ÊñáÊú¨: ${text}`);
      
      const speak = (text, times = 0) => {
        if (times >= 2) {
          console.log('üîä ËØ≠Èü≥Êí≠Êä•ÂÆåÊàêÔºåÂ∑≤Êí≠Êä•2Ê¨°');
          return; // Âè™Êí≠Êä•2Ê¨°
        }
        
        console.log(`üîä ÂºÄÂßãÁ¨¨${times + 1}Ê¨°ËØ≠Èü≥Êí≠Êä•`);
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN'; // ËÆæÁΩÆ‰∏∫‰∏≠Êñá
        utterance.rate = 0.7; // ËØ≠ÈÄüÈÄÇ‰∏≠ÔºåÁ°Æ‰øùÊâãÊú∫Âè∑ËÉΩÂê¨Ê∏Ö‰ΩÜ‰∏ç‰ºöÂ§™ÊÖ¢
        utterance.pitch = 1.0; // Ê≠£Â∏∏Èü≥Ë∞É
        utterance.volume = 0.8; // Èü≥Èáè
        
        utterance.onstart = () => {
          console.log(`üîä Á¨¨${times + 1}Ê¨°ËØ≠Èü≥Êí≠Êä•ÂºÄÂßã`);
        };
        
        utterance.onend = () => {
          console.log(`üîä Á¨¨${times + 1}Ê¨°ËØ≠Èü≥Êí≠Êä•ÁªìÊùü`);
          // Êí≠Êä•ÁªìÊùüÂêéÔºåÂª∂Ëøü3ÁßíÊí≠Êä•Á¨¨‰∫åÊ¨°ÔºàÁªôÊõ¥Â§öÊó∂Èó¥ÁêÜËß£ÊâãÊú∫Âè∑Ôºâ
          if (times < 1) {
            console.log('üîä 3ÁßíÂêéÂºÄÂßãÁ¨¨‰∫åÊ¨°Êí≠Êä•...');
            setTimeout(() => {
              speak(text, times + 1);
            }, 3000);
          }
        };
        
        utterance.onerror = (event) => {
          console.error('üîä ËØ≠Èü≥Êí≠Êä•Â§±Ë¥•:', event);
        };
        
        window.speechSynthesis.speak(utterance);
      };
      
      speak(text);
    } else {
      console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÂäüËÉΩ');
    }
  } catch (error) {
    console.error('ËØ≠Èü≥Êí≠Êä•Âá∫Èîô:', error);
  }
};

// Â§ÑÁêÜTokenËøáÊúüÈÄöÁü•
const handleTokenExpiredNotification = (data) => {
  console.log('üîî Êî∂Âà∞TokenËøáÊúüÈÄöÁü•:', data);
  
  try {
    // Êõ¥Êñ∞ËøáÊúüÁî®Êà∑‰ø°ÊÅØÔºåÊ∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•
    const count = data.count || 0;
    const users = Array.isArray(data.expired_users) ? data.expired_users : [];
    
    console.log(`üîî Â§ÑÁêÜËøáÊúüÈÄöÁü• - Êï∞Èáè: ${count}, Áî®Êà∑: `, users);
    
    // Âè™ÊúâÂΩìÊúâËøáÊúüÁî®Êà∑Êó∂ÊâçÊòæÁ§∫ÈÄöÁü•ÂíåÊí≠Êä•
    if (count > 0 && users.length > 0) {
      // Á¥ØÁßØËøáÊúüÁî®Êà∑Ôºå‰∏çÊõøÊç¢‰πãÂâçÁöÑ
      if (expiredNotificationVisible.value) {
        // Â¶ÇÊûúÂºπÁ™óÂ∑≤ÁªèÊòæÁ§∫ÔºåÁ¥ØÁßØÊñ∞ÁöÑËøáÊúüÁî®Êà∑
        const existingPhones = new Set(expiredNotification.users.map(u => u.phone));
        const newUsers = users.filter(u => !existingPhones.has(u.phone));
        
        if (newUsers.length > 0) {
          expiredNotification.users.push(...newUsers);
          expiredNotification.count = expiredNotification.users.length;
          console.log(`üö® Á¥ØÁßØÊñ∞ÁöÑËøáÊúüÁî®Êà∑ ${newUsers.length} ‰∏™ÔºåÊÄªËÆ° ${expiredNotification.count} ‰∏™`);
        }
      } else {
        // Â¶ÇÊûúÂºπÁ™óÊú™ÊòæÁ§∫ÔºåÁõ¥Êé•ËÆæÁΩÆÊñ∞Êï∞ÊçÆ
        expiredNotification.count = count;
        expiredNotification.users = users;
        console.log(`üö® ÂèëÁé∞ ${count} ‰∏™ËøáÊúüÁî®Êà∑ÔºåÂáÜÂ§áÊòæÁ§∫ÈÄöÁü•ÂíåÊí≠Êä•`);
      }
      
      // ÊòæÁ§∫ÂºπÁ™óÈÄöÁü•
      showExpiredNotification();
      
      // ËØ≠Èü≥Êí≠Êä•ËøáÊúüÈÄöÁü•Ôºà‰ªÖÂú®ÂºÄÂêØÊó∂Ôºâ
      if (tokenMonitor.voiceEnabled) {
        console.log('üîä ÂºÄÂßãËØ≠Èü≥Êí≠Êä•...');
        speakExpiredNotification(users);
      } else {
        console.log('üîá ËØ≠Èü≥Êí≠Êä•Â∑≤ÂÖ≥Èó≠ÔºåË∑≥ËøáÊí≠Êä•');
      }
    } else {
      console.log('üîî Êú™Ê£ÄÊµãÂà∞Êñ∞ÁöÑËøáÊúüÁî®Êà∑');
    }
    
    // Êõ¥Êñ∞ÁõëÊéßÁä∂ÊÄÅ
    tokenMonitor.expiredCount = data.total_expired || 0;
    console.log('üìä Êõ¥Êñ∞ÊÄªËøáÊúüÊï∞Èáè:', tokenMonitor.expiredCount);
  } catch (error) {
    console.error('Â§ÑÁêÜTokenËøáÊúüÈÄöÁü•Êó∂Âá∫Èîô:', error);
  }
};

// ÊòæÁ§∫TokenËøáÊúüÈÄöÁü•ÂºπÁ™ó
const showExpiredNotification = () => {
  try {
    console.log('üö® ÊòæÁ§∫TokenËøáÊúüÈÄöÁü•ÂºπÁ™ó');
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
    if (countdownTimer) {
      clearInterval(countdownTimer);
      countdownTimer = null;
    }
    
    // ÊòæÁ§∫ÂºπÁ™óÔºå‰∏çÂÜçËá™Âä®ÂÖ≥Èó≠
    expiredNotificationVisible.value = true;
    notificationCountdown.value = 0; // ‰∏çÊòæÁ§∫ÂÄíËÆ°Êó∂
    notificationProgress.value = 0;
    
    console.log('üö® TokenËøáÊúüÈÄöÁü•ÂºπÁ™óÂ∑≤ÊòæÁ§∫ÔºåÈúÄÊâãÂä®ÂÖ≥Èó≠');
  } catch (error) {
    console.error('ÊòæÁ§∫ËøáÊúüÈÄöÁü•Êó∂Âá∫Èîô:', error);
  }
};

// ÂÖ≥Èó≠TokenËøáÊúüÈÄöÁü•
const closeExpiredNotification = () => {
  console.log('‚úñÔ∏è ÂÖ≥Èó≠TokenËøáÊúüÈÄöÁü•ÂºπÁ™ó');
  expiredNotificationVisible.value = false;
  if (countdownTimer) {
    clearInterval(countdownTimer);
    countdownTimer = null;
  }
  
  // Ê∏ÖÁ©∫ÈÄöÁü•Êï∞ÊçÆÔºå‰∏∫‰∏ãÊ¨°ÈÄöÁü•ÂÅöÂáÜÂ§á
  expiredNotification.count = 0;
  expiredNotification.users = [];
  console.log('‚úñÔ∏è TokenËøáÊúüÈÄöÁü•Â∑≤ÂÖ≥Èó≠ÔºåÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫');
};

// Êü•ÁúãËøáÊúüËØ¶ÊÉÖ
const viewExpiredDetails = () => {
  closeExpiredNotification();
  // ÂèØ‰ª•Ë∑≥ËΩ¨Âà∞ËØ¶ÁªÜÈ°µÈù¢ÊàñÊòæÁ§∫Êõ¥Â§ö‰ø°ÊÅØ
  message.info('Êü•ÁúãËØ¶ÊÉÖÂäüËÉΩÂæÖÂºÄÂèë');
};

// Êõ¥Êñ∞ÁõëÊéßÁä∂ÊÄÅ
const updateMonitorStatus = (data) => {
  tokenMonitor.totalUsers = data.total_users || 0;
  tokenMonitor.expiredCount = data.total_expired || 0;
  tokenMonitor.lastCheck = data.last_check;
  tokenMonitor.isRunning = data.is_running || false;
};

// HTTPËΩÆËØ¢‰∏çÈúÄË¶ÅÂøÉË∑≥‰øùÊ¥ª
</script>

<style scoped>
.expired-notification {
  text-align: center;
  padding: 20px 0;
}

.notification-icon {
  margin-bottom: 16px;
}

.notification-content h3 {
  color: #faad14;
  margin-bottom: 16px;
  font-size: 18px;
}

.expired-users {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 16px;
}

.expired-user-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.expired-user-item:last-child {
  border-bottom: none;
}

.user-token {
  color: #666;
  font-size: 12px;
  margin-left: 8px;
}

.notification-footer {
  margin-top: 16px;
}

.auto-close-text {
  margin-top: 8px;
  color: #666;
  font-size: 12px;
}

.notification-actions {
  text-align: center;
  margin-top: 16px;
}

.notification-actions .ant-btn {
  margin: 0 8px;
}

/* TokenÊ£ÄÊü•ËøõÂ∫¶Êù°Ê†∑Âºè */
.token-check-progress {
  position: relative;
  z-index: 10;
  margin-bottom: 8px;
}

.progress-bar-container {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 8px 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.progress-title {
  font-size: 13px;
  font-weight: 500;
  color: #1890ff;
}

.progress-actions {
  display: flex;
  gap: 4px;
}

.progress-content {
  margin-top: 6px;
}

.progress-info {
  margin-top: 4px;
  font-size: 11px;
  color: #666;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.progress-minimized {
  text-align: center;
}

.mini-progress {
  font-size: 12px;
  color: #1890ff;
  font-weight: 500;
}

@media (max-width: 768px) {
  .progress-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
  }
  
  .progress-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}
</style>
